
> @llm-boost/api@0.0.1 test /Users/lsendel/Projects/LLMRank_app/apps/api
> vitest run


 RUN  v3.2.4 /Users/lsendel/Projects/LLMRank_app/apps/api

 âœ“ src/__tests__/middleware/hmac.test.ts (14 tests) 12ms
 âœ“ src/__tests__/lib/concurrent.test.ts (4 tests) 46ms
 âœ“ src/__tests__/services/ingest-service.test.ts (23 tests) 17ms
 âœ“ src/__tests__/middleware/api-token-auth.test.ts (24 tests) 17ms
(node:99894) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
(node:99890) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
(node:99897) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
(node:99896) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
(node:99895) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
(node:99893) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
(node:99891) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
(node:99913) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
(node:99930) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
stderr | src/__tests__/integration/browser.test.ts > Browser Routes > POST /api/browser/audit > returns 500 when browser launch fails
Unhandled test error: Browser unavailable

 âœ“ src/__tests__/integration/admin.test.ts (15 tests) 19ms
stderr | src/__tests__/integration/ingest.test.ts > Ingest Routes > POST /ingest/batch > accepts valid HMAC-signed batch payload
Unhandled test error: This context has no ExecutionContext

 âœ“ src/__tests__/integration/pages.test.ts (13 tests) 19ms
 âœ“ src/__tests__/integration/fixes.test.ts (13 tests) 23ms
stdout | src/__tests__/integration/reports.test.ts > Report Routes > GET /api/reports/:id/download > streams file for completed PDF report
Downloading report 33333333-3333-3333-3333-333333333333 from R2 key: reports/test-report.pdf

stdout | src/__tests__/integration/reports.test.ts > Report Routes > GET /api/reports/:id/download > streams file for completed DOCX report
Downloading report 33333333-3333-3333-3333-333333333333 from R2 key: reports/test-report.docx

stdout | src/__tests__/integration/reports.test.ts > Report Routes > GET /api/reports/:id/download > returns 409 for non-complete report
Report 33333333-3333-3333-3333-333333333333 not ready: status=generating, r2Key=null

stdout | src/__tests__/integration/reports.test.ts > Report Routes > GET /api/reports/:id/download > returns 404 when R2 object missing
Downloading report 33333333-3333-3333-3333-333333333333 from R2 key: reports/missing-file.pdf

stderr | src/__tests__/integration/reports.test.ts > Report Routes > GET /api/reports/:id/download > returns 404 when R2 object missing
Report 33333333-3333-3333-3333-333333333333 file not found in R2 key: reports/missing-file.pdf

 âœ“ src/__tests__/integration/reports.test.ts (21 tests) 25ms
 âœ“ src/__tests__/integration/ingest.test.ts (8 tests) 29ms
 âœ“ src/__tests__/integration/account.test.ts (7 tests) 23ms
 âœ“ src/__tests__/integration/projects.test.ts (9 tests) 24ms
stderr | src/__tests__/integration/browser.test.ts > Browser Routes > POST /api/browser/audit > returns 500 when page navigation fails
Browser audit failed: Error: Navigation timeout
    at [90m/Users/lsendel/Projects/LLMRank_app/apps/api/[39msrc/__tests__/integration/browser.test.ts:210:43
    at file:///Users/lsendel/Projects/LLMRank_app/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:155:11
    at file:///Users/lsendel/Projects/LLMRank_app/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:26
    at file:///Users/lsendel/Projects/LLMRank_app/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///Users/lsendel/Projects/LLMRank_app/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:1863:10)
    at runTest (file:///Users/lsendel/Projects/LLMRank_app/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:1574:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at runSuite (file:///Users/lsendel/Projects/LLMRank_app/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:1729:8)
    at runSuite (file:///Users/lsendel/Projects/LLMRank_app/node_modules/[4m.pnpm[24m/@vitest+runner@3.2.4/node_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:1729:8)

 âœ“ src/__tests__/integration/browser.test.ts (9 tests) 32ms
 âœ“ src/__tests__/integration/integrations.test.ts (42 tests) 45ms
(node:99941) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
stderr | src/__tests__/lib/fetch-retry.test.ts > fetchWithRetry > retries on network error and succeeds
{"level":"warn","msg":"Attempt 1/3 failed: fetch failed","ts":"2026-02-16T21:53:07.470Z","context":"fetch-retry","url":"https://crawler.test/api/v1/jobs"}

stderr | src/__tests__/lib/fetch-retry.test.ts > fetchWithRetry > retries on 5xx and succeeds
{"level":"warn","msg":"Attempt 1/3 got 503","ts":"2026-02-16T21:53:07.473Z","context":"fetch-retry","url":"https://crawler.test/api/v1/jobs","status":503}

stderr | src/__tests__/lib/fetch-retry.test.ts > fetchWithRetry > throws after all retries exhausted on network error
{"level":"warn","msg":"Attempt 1/3 failed: fail 1","ts":"2026-02-16T21:53:07.474Z","context":"fetch-retry","url":"https://crawler.test/api/v1/jobs"}

stderr | src/__tests__/lib/fetch-retry.test.ts > fetchWithRetry > throws after all retries exhausted on network error
{"level":"warn","msg":"Attempt 2/3 failed: fail 2","ts":"2026-02-16T21:53:07.475Z","context":"fetch-retry","url":"https://crawler.test/api/v1/jobs"}

stderr | src/__tests__/lib/fetch-retry.test.ts > fetchWithRetry > throws after all retries exhausted on network error
{"level":"warn","msg":"Attempt 3/3 failed: fail 3","ts":"2026-02-16T21:53:07.476Z","context":"fetch-retry","url":"https://crawler.test/api/v1/jobs"}

stderr | src/__tests__/lib/fetch-retry.test.ts > fetchWithRetry > returns last 5xx response after all retries exhausted
{"level":"warn","msg":"Attempt 1/3 got 502","ts":"2026-02-16T21:53:07.477Z","context":"fetch-retry","url":"https://crawler.test/api/v1/jobs","status":502}

stderr | src/__tests__/lib/fetch-retry.test.ts > fetchWithRetry > returns last 5xx response after all retries exhausted
{"level":"warn","msg":"Attempt 2/3 got 503","ts":"2026-02-16T21:53:07.478Z","context":"fetch-retry","url":"https://crawler.test/api/v1/jobs","status":503}

stderr | src/__tests__/lib/fetch-retry.test.ts > fetchWithRetry > returns last 5xx response after all retries exhausted
{"level":"warn","msg":"Attempt 3/3 got 504","ts":"2026-02-16T21:53:07.479Z","context":"fetch-retry","url":"https://crawler.test/api/v1/jobs","status":504}

stderr | src/__tests__/lib/fetch-retry.test.ts > fetchWithRetry > respects custom maxRetries
{"level":"warn","msg":"Attempt 1/2 failed: fail","ts":"2026-02-16T21:53:07.480Z","context":"fetch-retry","url":"https://crawler.test/api/v1/jobs"}

stderr | src/__tests__/lib/fetch-retry.test.ts > fetchWithRetry > respects custom maxRetries
{"level":"warn","msg":"Attempt 2/2 failed: fail","ts":"2026-02-16T21:53:07.481Z","context":"fetch-retry","url":"https://crawler.test/api/v1/jobs"}

 âœ“ src/__tests__/lib/fetch-retry.test.ts (7 tests) 13ms
 âœ“ src/__tests__/routes/report-upload.test.ts (3 tests) 10ms
 âœ“ src/__tests__/services/strategy-service.test.ts (24 tests) 15ms
stdout | src/__tests__/services/crawl-service.test.ts > CrawlService > requestCrawl > creates crawl job and dispatches to crawler
[crawl] dispatching to https://crawler.test/api/v1/jobs

 âœ“ src/__tests__/services/competitor-benchmark-service.test.ts (8 tests) 11ms
stdout | src/__tests__/services/crawl-service.test.ts > CrawlService > requestCrawl > marks job failed when crawler dispatch returns non-OK
[crawl] dispatching to https://crawler.test/api/v1/jobs

stderr | src/__tests__/services/crawl-service.test.ts > CrawlService > requestCrawl > marks job failed when crawler dispatch returns non-OK
[crawl] dispatch rejected: 503 body=

stdout | src/__tests__/services/crawl-service.test.ts > CrawlService > requestCrawl > retries on network error and succeeds
[crawl] dispatching to https://crawler.test/api/v1/jobs

stdout | src/__tests__/services/crawl-service.test.ts > CrawlService > requestCrawl > throws CRAWLER_UNAVAILABLE after all retries exhausted
[crawl] dispatching to https://crawler.test/api/v1/jobs

stderr | src/__tests__/services/crawl-service.test.ts > CrawlService > requestCrawl > throws CRAWLER_UNAVAILABLE after all retries exhausted
[crawl] dispatch error: Error: Connection refused
    at /Users/lsendel/Projects/LLMRank_app/apps/api/src/__tests__/services/crawl-service.test.ts:198:44
    at file:///Users/lsendel/Projects/LLMRank_app/node_modules/.pnpm/@vitest+runner@3.2.4/node_modules/@vitest/runner/dist/chunk-hooks.js:155:11
    at file:///Users/lsendel/Projects/LLMRank_app/node_modules/.pnpm/@vitest+runner@3.2.4/node_modules/@vitest/runner/dist/chunk-hooks.js:752:26
    at file:///Users/lsendel/Projects/LLMRank_app/node_modules/.pnpm/@vitest+runner@3.2.4/node_modules/@vitest/runner/dist/chunk-hooks.js:1897:20
    at new Promise (<anonymous>)
    at runWithTimeout (file:///Users/lsendel/Projects/LLMRank_app/node_modules/.pnpm/@vitest+runner@3.2.4/node_modules/@vitest/runner/dist/chunk-hooks.js:1863:10)
    at runTest (file:///Users/lsendel/Projects/LLMRank_app/node_modules/.pnpm/@vitest+runner@3.2.4/node_modules/@vitest/runner/dist/chunk-hooks.js:1574:12)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at runSuite (file:///Users/lsendel/Projects/LLMRank_app/node_modules/.pnpm/@vitest+runner@3.2.4/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)
    at runSuite (file:///Users/lsendel/Projects/LLMRank_app/node_modules/.pnpm/@vitest+runner@3.2.4/node_modules/@vitest/runner/dist/chunk-hooks.js:1729:8)

stdout | src/__tests__/services/crawl-service.test.ts > CrawlService > requestCrawl > allows crawl when previous is complete
[crawl] dispatching to https://crawler.test/api/v1/jobs

 âœ“ src/__tests__/services/crawl-service.test.ts (38 tests) 27ms
 âœ“ src/__tests__/integration/billing.test.ts (16 tests) 17ms
 âœ“ src/__tests__/services/api-token-service.test.ts (11 tests) 10ms
 âœ“ src/__tests__/services/page-service.test.ts (14 tests) 10ms
 âœ“ src/__tests__/services/visibility-service.test.ts (7 tests) 6ms
 âœ“ src/__tests__/middleware/planLimits.test.ts (6 tests) 6ms
 âœ“ src/__tests__/middleware/rate-limit.test.ts (8 tests) 8ms
stdout | src/__tests__/services/notification-service.test.ts > NotificationService > queueEmail > enqueues payload with template namespace and new columns
{"level":"info","msg":"Queueing email notification","ts":"2026-02-16T21:53:08.750Z","context":"notification-service","userId":"u1","template":"crawl_completed"}

stdout | src/__tests__/services/notification-service.test.ts > NotificationService > sendCrawlComplete > queues notification when user has email
{"level":"info","msg":"Queueing email notification","ts":"2026-02-16T21:53:08.752Z","context":"notification-service","userId":"user-1","template":"crawl_completed"}

stdout | src/__tests__/services/notification-service.test.ts > NotificationService > sendCrawlComplete > uses cached summary data when available
{"level":"info","msg":"Queueing email notification","ts":"2026-02-16T21:53:08.753Z","context":"notification-service","userId":"user-1","template":"crawl_completed"}

stdout | src/__tests__/services/notification-service.test.ts > NotificationService > sendCrawlComplete > falls back to null metrics when no scores exist
{"level":"info","msg":"Queueing email notification","ts":"2026-02-16T21:53:08.754Z","context":"notification-service","userId":"user-1","template":"crawl_completed"}

stdout | src/__tests__/services/notification-service.test.ts > NotificationService > sendScoreDrop > queues alert when score decreases
{"level":"info","msg":"Queueing email notification","ts":"2026-02-16T21:53:08.754Z","context":"notification-service","userId":"user-1","template":"score_drop"}

stderr | src/__tests__/services/notification-service.test.ts > NotificationService > processQueue > increments attempt count on send failure
{"level":"error","msg":"Failed to process notification event","ts":"2026-02-16T21:53:08.755Z","context":"notification-service","eventId":"evt-1","error":"Error: SMTP error"}

 âœ“ src/__tests__/services/notification-service.test.ts (18 tests) 10ms
(node:164) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
(node:159) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
(node:162) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
(node:161) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
 âœ“ src/__tests__/services/project-service.test.ts (10 tests) 8ms
 âœ“ src/__tests__/integration/logs.test.ts (11 tests) 13ms
 âœ“ src/__tests__/integration/competitors.test.ts (14 tests) 16ms
 âœ“ src/__tests__/integration/extractors.test.ts (16 tests) 15ms
 âœ“ src/__tests__/integration/strategy.test.ts (27 tests) 18ms
(node:175) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
 âœ“ src/__tests__/services/notification-channel-service.test.ts (12 tests) 4ms
 âœ“ src/__tests__/middleware/admin.test.ts (4 tests) 6ms
(node:180) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
(node:179) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
 âœ“ src/__tests__/routes/insights.test.ts (4 tests) 7ms
 âœ“ src/__tests__/routes/visibility-schedules.test.ts (18 tests) 5ms
 âœ“ src/__tests__/services/log-service.test.ts (12 tests) 10ms
 âœ“ src/__tests__/integration/scores.test.ts (4 tests) 9ms
 âœ“ src/__tests__/integration/health.test.ts (5 tests) 15ms
 âœ“ src/__tests__/integration/visibility.test.ts (5 tests) 10ms
 âœ“ src/__tests__/lib/crypto.test.ts (4 tests) 7ms
 âœ“ src/__tests__/services/fix-generator-service.test.ts (5 tests) 5ms
 âœ“ src/__tests__/middleware/auth.test.ts (3 tests) 7ms
 âœ“ src/__tests__/services/summary.test.ts (8 tests) 4ms
 âœ“ src/__tests__/services/scheduled-visibility-service.test.ts (19 tests) 5ms
 âœ“ src/__tests__/services/insights-service.test.ts (8 tests) 11ms
 âœ“ src/__tests__/services/enrichments.test.ts (10 tests) 3ms
 âœ“ src/__tests__/lib/google-oauth.test.ts (5 tests) 4ms
 âœ“ src/__tests__/services/admin-service.test.ts (5 tests) 6ms
 âœ“ src/__tests__/services/llm-scoring.test.ts (16 tests) 4ms
 âœ“ src/__tests__/lib/html-parser.test.ts (13 tests) 8ms
 âœ“ src/__tests__/services/billing-service.test.ts (9 tests) 7ms
 âœ“ src/__tests__/services/monitoring-service.test.ts (9 tests) 9ms
stdout | src/__tests__/services/digest-service.test.ts > DigestService > processWeeklyDigests > sends weekly digest emails for due users
{"level":"info","msg":"Weekly digest processing complete","ts":"2026-02-16T21:53:10.059Z","context":"digest-service","sent":1,"total":1}

stdout | src/__tests__/services/digest-service.test.ts > DigestService > processWeeklyDigests > skips users with no projects
{"level":"info","msg":"Weekly digest processing complete","ts":"2026-02-16T21:53:10.062Z","context":"digest-service","sent":0,"total":1}

stdout | src/__tests__/services/digest-service.test.ts > DigestService > processWeeklyDigests > skips projects with no completed crawls
{"level":"info","msg":"Weekly digest processing complete","ts":"2026-02-16T21:53:10.062Z","context":"digest-service","sent":1,"total":1}

stdout | src/__tests__/services/digest-service.test.ts > DigestService > processWeeklyDigests > returns 0 when no users are due
{"level":"info","msg":"Weekly digest processing complete","ts":"2026-02-16T21:53:10.063Z","context":"digest-service","sent":0,"total":0}

stderr | src/__tests__/services/digest-service.test.ts > DigestService > processWeeklyDigests > continues processing after individual user failure
{"level":"error","msg":"Failed to send weekly digest","ts":"2026-02-16T21:53:10.063Z","context":"digest-service","userId":"u1","error":"DB timeout"}

stdout | src/__tests__/services/digest-service.test.ts > DigestService > processWeeklyDigests > continues processing after individual user failure
{"level":"info","msg":"Weekly digest processing complete","ts":"2026-02-16T21:53:10.063Z","context":"digest-service","sent":1,"total":2}

stdout | src/__tests__/services/digest-service.test.ts > DigestService > processMonthlyDigests > sends a cross-project monthly digest
{"level":"info","msg":"Monthly digest processing complete","ts":"2026-02-16T21:53:10.063Z","context":"digest-service","sent":1,"total":1}

stdout | src/__tests__/services/digest-service.test.ts > DigestService > processMonthlyDigests > returns 0 when no users are due
{"level":"info","msg":"Monthly digest processing complete","ts":"2026-02-16T21:53:10.064Z","context":"digest-service","sent":0,"total":0}

 âœ“ src/__tests__/services/digest-service.test.ts (7 tests) 6ms
(node:188) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
 âœ“ src/__tests__/services/frontier-service.test.ts (6 tests) 3ms
 âœ“ src/__tests__/lib/kv-cache.test.ts (4 tests) 3ms
 âœ“ src/__tests__/services/regression-service.test.ts (8 tests) 3ms
 âœ“ src/__tests__/lib/sitemap.test.ts (7 tests) 3ms
 âœ“ src/__tests__/middleware/request-id.test.ts (1 test) 2ms
 âœ“ src/__tests__/services/progress-service.test.ts (3 tests) 4ms
 âœ“ src/__tests__/services/intelligence-service.test.ts (3 tests) 4ms
stdout | src/__tests__/integration/crawls.test.ts > Crawl Routes > POST /api/crawls > returns 201 when creating a crawl with valid projectId
[crawl] dispatching to http://localhost:3000/api/v1/jobs

 âœ“ src/__tests__/integration/crawls.test.ts (7 tests) 14ms
 âœ“ src/__tests__/lib/sentry.test.ts (2 tests) 2ms
 âœ“ src/__tests__/lib/email.test.ts (3 tests) 1ms
(node:245) Warning: `--localstorage-file` was provided without a valid path
(Use `node --trace-warnings ...` to show where the warning was created)
 âœ“ src/__tests__/services/integration-insights-service.test.ts (4 tests) 3ms
 âœ“ src/__tests__/integration/dashboard.test.ts (3 tests) 8ms
 âœ“ src/__tests__/integration/public.test.ts (19 tests) 11036ms
   âœ“ Public Routes > POST /api/public/scan > returns 200 with scan results for valid URL  2426ms
   âœ“ Public Routes > POST /api/public/scan > auto-prepends https:// when missing  3066ms
   âœ“ Public Routes > POST /api/public/scan > persists scan result to database  2861ms
   âœ“ Public Routes > POST /api/public/scan > detects AI crawler blocks in robots.txt  2651ms

 Test Files  65 passed (65)
      Tests  695 passed (695)
   Start at  16:53:04
   Duration  13.59s (transform 1.96s, setup 0ms, collect 43.08s, tests 11.78s, environment 8ms, prepare 5.45s)

